<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Винная Карта — Авиатор</title>
<link href="https://fonts.googleapis.com/css?family=Alegreya+SC:500,700&display=swap" rel="stylesheet">
<style>
:root {
    --bg-sand: #faf7f0;
    --bg-ice: #fff6f2;
    --ink: #2f2621;
    --accent: #7f1212;
    --accent-strong: #5a0505;
    --accent-soft: #ffb97d;
    --line: rgba(111, 10, 10, 0.18);
    --card: #ffffff;
}
body { margin:0; padding:0; min-height:100vh; font-family:'Alegreya SC', sans-serif; background:radial-gradient(circle at 18% 12%, rgba(127,18,18,0.08) 0%, transparent 36%), linear-gradient(180deg, var(--bg-sand) 0%, #fffaf4 55%, #f8f1e8 100%); color:var(--ink); display:flex; flex-direction:column; }
header { width:100%; display:flex; justify-content:center; padding:24px 18px 12px; background:transparent; border-bottom:none; position:sticky; top:0; z-index:20; }
.logo-container {
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    padding:18px 26px;
    margin:0 auto;
    border-radius:20px;
    border:1px solid rgba(111,10,10,0.12);
    background:white;
    box-shadow:0 12px 30px rgba(111,10,10,0.08);
}
.logo-container img { display:block; max-width:150px; height:auto; }
main { flex:1; padding:15px; }
h1 { font-size:1.6rem; text-align:center; margin-bottom:15px; background: linear-gradient(135deg, #7f1212 0%, #a72a2a 55%, #5a0505 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

.filters-toggle-row {
    display:flex;
    justify-content:center;
    margin:4px 0 18px;
}
.filters-toggle {
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:12px 22px;
    border-radius:14px;
    border:1px solid var(--line);
    background:linear-gradient(120deg, var(--accent) 0%, #b63d3d 55%, var(--accent-strong) 100%);
    color:#f7fffc;
    font-size:0.95rem;
    font-weight:700;
    cursor:pointer;
    letter-spacing:0.03em;
    box-shadow:0 14px 28px rgba(15, 143, 115, 0.18);
    transition:transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
}
.filters-toggle:hover {
    transform:translateY(-2px);
    box-shadow:0 16px 36px rgba(127, 18, 18, 0.26);
}
.filters-toggle:active {
    transform:translateY(0);
}
.filters-toggle.is-active {
    background:linear-gradient(120deg, #5a0505 0%, #7f1212 60%, #681010 100%);
}
.filters-popover {
    position:fixed;
    inset:0;
    display:none;
    align-items:flex-start;
    justify-content:center;
    padding:80px 16px 24px;
    z-index:40;
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
}
.filters-popover.is-open {
    display:flex;
}
.filters-popover__backdrop {
    position:absolute;
    inset:0;
    background:rgba(12, 16, 14, 0.35);
    backdrop-filter:blur(5px);
}
.filters-popover__panel {
    position:relative;
    width:min(95vw, 960px);
    z-index:1;
    max-height:calc(100vh - 120px);
    overflow:auto;
    padding:12px;
    border-radius:22px;
    border:1px solid rgba(127,18,18,0.18);
    background:radial-gradient(circle at 18% 12%, rgba(255,230,221,0.55), transparent 48%), linear-gradient(180deg, rgba(255,255,255,0.82) 0%, rgba(255,248,244,0.95) 70%, rgba(255,245,240,0.9) 100%);
    box-shadow:0 20px 46px rgba(51,18,18,0.18), inset 0 1px 0 rgba(255,255,255,0.35);
}
body.filters-open {
    overflow:hidden;
}
.filters__intro {
    display:flex;
    flex-direction:column;
    gap:6px;
    flex:1 1 auto;
    min-width:min(240px, 100%);
}
.filters__actions {
    position:relative;
    z-index:1;
    display:flex;
    flex-wrap:wrap;
    justify-content:flex-end;
    gap:10px;
    margin-top:4px;
}
.filters__close {
    border:none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding:12px 28px;
    background:linear-gradient(135deg, #7f1212 0%, #b63d3d 55%, #5a0505 100%);
    color:#ffffff;
    font-size:0.92rem;
    font-weight:700;
    border-radius:16px;
    cursor:pointer;
    box-shadow:0 12px 24px rgba(127,18,18,0.18);
    transition:transform 0.25s ease, box-shadow 0.25s ease;
}
.filters__close:hover {
    transform:translateY(-2px);
    box-shadow:0 18px 34px rgba(127,18,18,0.24);
}
.filters__close:active {
    transform:translateY(0);
    box-shadow:0 10px 20px rgba(127,18,18,0.15);
}
.filters__clear {
    border:1px solid var(--line);
    background:linear-gradient(180deg, #fffaf4 0%, #fff4ed 100%);
    color:var(--accent-strong);
    padding:10px 20px;
    border-radius:14px;
    font-size:0.9rem;
    font-weight:700;
    cursor:pointer;
    transition:color 0.2s ease, background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
}
.filters__clear:hover {
    background:#fff1e8;
    border-color:rgba(127,18,18,0.35);
    transform:translateY(-1px);
}
.filters__clear:active {
    transform:translateY(0);
}

.filters {
    position:relative;
    display:flex;
    flex-direction:column;
    gap:18px;
    padding:22px 24px 24px;
    margin-bottom:20px;
    border-radius:20px;
    border:1px solid var(--line);
    background:linear-gradient(140deg, rgba(255,244,235,0.96) 0%, rgba(255,255,255,0.98) 52%, #fff5ef 100%);
    box-shadow:0 12px 30px rgba(127,18,18,0.08);
    overflow:hidden;
    z-index:0;
}
.filters::after {
    content:'';
    position:absolute;
    inset:0;
    background:radial-gradient(circle at 82% 18%, rgba(127, 18, 18, 0.08), transparent 55%);
    pointer-events:none;
    z-index:0;
}
.filters__header,
.filters__grid {
    position:relative;
    z-index:1;
}
.filters__header {
    display:flex;
    flex-wrap:wrap;
    align-items:flex-start;
    justify-content:flex-start;
    gap:12px;
}
.filters__title {
    margin:0;
    font-size:1.2rem;
    font-weight:700;
    color:var(--accent-strong);
    letter-spacing:0.02em;
}
.filters__hint {
    margin:4px 0 0;
    font-size:0.8rem;
    color:rgba(47,38,33,0.78);
    max-width:28rem;
    line-height:1.4;
}
.filters__grid {
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));
    gap:14px 18px;
}
.filter-box {
    display:flex;
    flex-direction:column;
    gap:6px;
    padding:12px 14px;
    border-radius:14px;
    background:rgba(255,255,255,0.94);
    border:1px solid rgba(127, 18, 18, 0.12);
    box-shadow:0 2px 10px rgba(127,18,18,0.06);
    transition:border-color 0.25s ease, box-shadow 0.25s ease, transform 0.25s ease, background 0.25s ease;
}
.filter-box:hover,
.filter-box:focus-within {
    border-color:rgba(127,18,18,0.35);
    box-shadow:0 10px 18px rgba(127,18,18,0.1);
    transform:translateY(-2px);
    background:#ffffff;
}
.filter-box label {
    font-size:0.75rem;
    text-transform:uppercase;
    letter-spacing:0.06em;
    font-weight:700;
    color:var(--accent-strong);
    display:flex;
    flex-direction:column;
    gap:6px;
}
.filter-box select,
.filter-box input[type="text"] {
    padding:10px 36px 10px 12px;
    font-size:0.95rem;
    border-radius:11px;
    border:1px solid rgba(127,18,18,0.24);
    background:#ffffff;
    font-family:inherit;
    color:var(--ink);
    transition:border-color 0.2s ease, box-shadow 0.2s ease;
    box-shadow:inset 0 1px 2px rgba(127,18,18,0.08);
    appearance:none;
    width:100%;
    box-sizing:border-box;
}
.filter-box select:not([multiple]) {
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='10' viewBox='0 0 14 10'%3E%3Cpath fill='none' stroke='%237f1212' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round' d='M1 2.5 7 7.5 13 2.5'/%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position:right 12px center;
    background-size:14px 10px;
    padding-right:40px;
}
.filter-box select:focus,
.filter-box input[type="text"]:focus {
    border-color:var(--accent-strong);
    box-shadow:0 0 0 3px rgba(127,18,18,0.12);
    outline:none;
}
.filter-box select[multiple] {
    min-height:120px;
    padding-right:12px;
}
.filter-chip-list {
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:flex-start;
}
.filter-chip-list--compact {
    gap:6px;
}
.filter-chip-list--scrollable {
    max-height:180px;
    overflow-y:auto;
    padding-right:4px;
    scrollbar-width:thin;
    -webkit-overflow-scrolling:touch;
}
.filter-chip-list--scrollable::-webkit-scrollbar {
    width:6px;
}
.filter-chip-list--scrollable::-webkit-scrollbar-thumb {
    background:rgba(127,18,18,0.35);
    border-radius:999px;
}
.filter-chip {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:8px 14px;
    font-size:0.9rem;
    font-weight:700;
    border-radius:999px;
    border:1px solid rgba(127,18,18,0.28);
    background:linear-gradient(180deg, #ffffff 0%, #f3fbf7 100%);
    color:var(--accent-strong);
    cursor:pointer;
    user-select:none;
    transition:background 0.2s ease, color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
}
.filter-chip:not(.is-selected):hover {
    transform:translateY(-1px);
    box-shadow:0 6px 16px rgba(127,18,18,0.12);
    border-color:rgba(127,18,18,0.4);
}
.filter-chip.is-selected {
    background:linear-gradient(135deg, var(--accent) 0%, #b63d3d 60%, var(--accent-strong) 100%);
    color:#ffffff;
    box-shadow:0 10px 24px rgba(127,18,18,0.18);
}
.filter-chip:focus-visible {
    outline:2px solid rgba(127,18,18,0.45);
    outline-offset:2px;
}
.filter-chip-empty {
    font-size:0.85rem;
    color:rgba(47,38,33,0.6);
}

.filter-box--wide {
    grid-column:span 2;
}
.filter-box--checkbox {
    padding:12px;
}
.filter-box--checkbox label {
    flex-direction:row;
    align-items:center;
    gap:10px;
    text-transform:none;
    letter-spacing:0;
    font-size:0.92rem;
    font-weight:700;
    color:var(--ink);
}
.filter-box--checkbox input[type="checkbox"] {
    margin:0;
    width:18px;
    height:18px;
    cursor:pointer;
    accent-color:var(--accent);
}
.filter-box.red-highlight {
    background:rgba(255,225,225,0.92);
    border-color:rgba(168,40,40,0.55);
}
.filter-box.white-highlight {
    background:rgba(255,255,221,0.92);
    border-color:rgba(179,165,56,0.55);
}
.filter-box.pink-highlight {
    background:rgba(255,220,235,0.92);
    border-color:rgba(182,101,133,0.55);
}

.dev-strip {
    display:none;
    flex-direction:column;
    align-items:center;
    gap:10px;
    margin:0 auto 18px;
    padding:14px 16px;
    width:min(520px, 100%);
    border-radius:16px;
    background:linear-gradient(120deg, rgba(127,18,18,0.08) 0%, rgba(167,42,42,0.12) 45%, rgba(90,5,5,0.12) 100%);
    border:1px dashed rgba(127,18,18,0.35);
    box-shadow:0 10px 24px rgba(127,18,18,0.08);
}
body.dev-mode .dev-strip {
    display:flex;
}
.dev-strip__label {
    margin:0;
    font-weight:800;
    letter-spacing:0.05em;
    text-transform:uppercase;
    color:var(--accent-strong);
    font-size:0.82rem;
}
.dev-strip__button {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding:10px 18px;
    border-radius:14px;
    border:1px solid var(--line);
    background:linear-gradient(135deg, #7f1212 0%, #b63d3d 55%, #5a0505 100%);
    color:#fff;
    font-weight:700;
    font-size:0.95rem;
    text-decoration:none;
    box-shadow:0 12px 24px rgba(127,18,18,0.16);
    transition:transform 0.2s ease, box-shadow 0.2s ease;
}
.dev-strip__button:hover {
    transform:translateY(-1px);
    box-shadow:0 16px 30px rgba(127,18,18,0.2);
}
.dev-strip__note {
    margin:0;
    color:rgba(47,38,33,0.7);
    font-size:0.85rem;
}
.dev-actions {
    display:none;
    margin-top:10px;
    gap:10px;
}
body.dev-mode .dev-actions {
    display:flex;
}
.dev-action-button {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    padding:8px 12px;
    border-radius:10px;
    border:1px solid var(--line);
    background:linear-gradient(180deg, #ffffff 0%, #fff3ee 100%);
    color:var(--accent-strong);
    font-weight:700;
    font-size:0.88rem;
    text-decoration:none;
    transition:transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
}
.dev-action-button:hover {
    transform:translateY(-1px);
    box-shadow:0 8px 18px rgba(127,18,18,0.18);
    border-color:rgba(127,18,18,0.35);
}
.dev-pill {
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:10px;
    background:rgba(127,18,18,0.12);
    color:var(--accent-strong);
    font-weight:700;
    font-size:0.78rem;
    text-transform:uppercase;
    letter-spacing:0.05em;
}
.dev-pill::before {
    content:'●';
    font-size:0.8rem;
    color:#b63d3d;
}

@media (max-width:900px) {
    .filters {
        padding:18px 18px 20px;
    }
    .filter-box--wide {
        grid-column:span 1;
    }
}

@media (max-width:600px) {
    .filters__grid {
        grid-template-columns:1fr;
    }
    .filters__actions {
        flex-direction:column;
        align-items:stretch;
        justify-content:flex-start;
    }
    .filters__close,
    .filters__clear {
        width:100%;
    }
    .filters::after {
        background:radial-gradient(circle at 90% 10%, rgba(111,10,10,0.1), transparent 45%);
    }
}

@media (max-width:700px) {
    .filters-popover {
        padding:60px 12px 16px;
    }
    .filters-popover__panel {
        width:100%;
        max-width:620px;
        max-height:calc(100vh - 80px);
    }
}

.wine-list-sorted .group-title {
    font-weight:700;
    font-size:1.1rem;
    margin:12px 0 6px;
    color:#2c3e50;
    border-left:4px solid #2980b9;
    padding-left:8px;
    background:#ecf0f1;
    border-radius:4px;
}
.wine-list-sorted .group-title.sub {
    font-weight:600;
    font-size:0.95rem;
    margin:6px 0 4px 20px;
    color:#34495e;
    border-left:3px solid #3498db;
    padding-left:6px;
    background:#f7f9fa;
}

.wine-list, .wine-list-sorted { display:flex; flex-direction:column; gap:10px; }

.wine-card {
    position:relative;
    display:flex;
    flex-direction:column;
    gap:12px;
    padding:20px 22px 22px;
    background:linear-gradient(140deg, rgba(255,244,235,0.96) 0%, rgba(255,255,255,0.98) 60%, #ffffff 100%);
    border-radius:20px;
    border:1px solid rgba(111,10,10,0.14);
    box-shadow:0 14px 32px rgba(111,10,10,0.08);
    cursor:pointer;
    transition:transform 0.28s ease, box-shadow 0.28s ease, opacity 0.4s ease, border-color 0.28s ease;
    opacity:0;
    transform:translateY(18px) scale(0.98);
    overflow:hidden;
}
.wine-card::after {
    content:'';
    position:absolute;
    inset:0;
    background:radial-gradient(circle at 85% 10%, rgba(111,10,10,0.08), transparent 55%);
    pointer-events:none;
    opacity:0.85;
}
.wine-card.show {
    opacity:1;
    transform:translateY(0) scale(1);
}
.wine-card:hover,
.wine-card:focus-within {
    transform:translateY(-4px) scale(1.01);
    box-shadow:0 18px 36px rgba(111,10,10,0.12);
    border-color:rgba(111,10,10,0.32);
}
.wine-card__media {
    position:relative;
    width:100%;
    height:220px;
    border-radius:16px;
    background:radial-gradient(circle at 30% 25%, rgba(255,229,210,0.65), rgba(255,255,255,0.95) 60%);
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    border:1px dashed rgba(111,10,10,0.18);
    box-shadow:inset 0 0 30px rgba(111,10,10,0.06);
    z-index:1;
}
.wine-card__media img {
    max-width:90%;
    max-height:90%;
    width:auto;
    height:auto;
    object-fit:contain;
    transform:translateZ(0);
    filter:drop-shadow(0 8px 16px rgba(111,10,10,0.18));
}
.wine-card__media--placeholder {
    font-size:0.85rem;
    font-weight:600;
    color:rgba(111,10,10,0.6);
    text-transform:uppercase;
    letter-spacing:0.08em;
    text-align:center;
    padding:0 16px;
}
.wine-card__body {
    position:relative;
    z-index:1;
    display:flex;
    flex-direction:column;
    gap:8px;
}
.wine-card h3 {
    font-size:1.05rem;
    margin:0;
    font-weight:700;
    color:#4c1b1b;
}
.wine-card .main-info {
    font-size:0.92rem;
    font-weight:600;
    color:#6f0a0a;
}
.wine-card .extra-info {
    font-size:0.85rem;
    color:rgba(49,49,49,0.75);
    line-height:1.45;
}
.wine-card .toggle-price {
    align-self:flex-start;
    display:flex;
    align-items:center;
    gap:8px;
    padding:8px 18px;
    background:rgba(111,10,10,0.08);
    border:1px solid rgba(111,10,10,0.25);
    border-radius:999px;
    color:#6f0a0a;
    cursor:pointer;
    font-size:0.85rem;
    font-family:inherit;
    letter-spacing:0.02em;
    transition:transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
}
.wine-card .toggle-price:hover {
    transform:translateY(-1px);
    background:rgba(111,10,10,0.12);
    box-shadow:0 6px 14px rgba(111,10,10,0.18);
}
.wine-card .toggle-price:focus {
    outline:2px solid rgba(111,10,10,0.28);
    outline-offset:2px;
}
.wine-card .toggle-price.is-hidden {
    display:none;
}
.wine-card .price {
    font-size:1.1rem;
    font-weight:700;
    color:#501010;
    display:block;
    margin:4px 0 2px;
    cursor:pointer;
    transition:color 0.2s ease;
}
.wine-card .price:focus-visible {
    outline:2px solid rgba(111,10,10,0.28);
    outline-offset:2px;
}
.wine-card .price:hover {
    color:#6f0a0a;
}
.wine-card .price.is-hidden {
    display:none;
}

/* выделяем игристое бордюром */
.wine-card.sparkling {
    border-color:rgba(255,215,0,0.55);
    box-shadow:0 18px 36px rgba(255,197,40,0.18);
}

.wine-card.sub {
    padding:18px;
    font-size:0.85rem;
    border-radius:18px;
    box-shadow:0 10px 24px rgba(111,10,10,0.07);
    gap:10px;
}
.wine-card.sub .wine-card__media {
    height:190px;
}
.wine-card.sub.show {
    transform:translateY(0) scale(0.99);
}
.wine-card.sub h3 {
    font-size:0.98rem;
}
.wine-card.sub .main-info {
    font-size:0.88rem;
}
.wine-card.sub .extra-info {
    font-size:0.8rem;
}
.bold { font-weight:bold; }
</style>
</head>
<body>
<header>
    <div class="logo-container">
        <img src="{{ url_for('static', filename='logo.jpg') }}" alt="VineLink">
    </div>
</header>
<main>
<h1>Винная Карта</h1>

<div class="filters-toggle-row">
    <button type="button" class="filters-toggle" id="filters-toggle" aria-haspopup="dialog" aria-expanded="false">
        Показать фильтры
    </button>
</div>
<div class="dev-strip" id="dev-strip" aria-live="polite">
    <div class="dev-pill">режим разработчика</div>
    <a class="dev-strip__button" id="dev-add-button" href="/winery/manage" target="_blank" rel="noopener">
        Добавить вино
    </a>
    <p class="dev-strip__note">Редактирование карточек доступно в списке ниже.</p>
</div>

<div class="filters-popover" id="filters-popover" aria-hidden="true">
    <div class="filters-popover__backdrop" id="filters-backdrop"></div>
    <div class="filters-popover__panel" role="dialog" aria-modal="true" aria-labelledby="filters-title">
        <div class="filters">
            <div class="filters__header">
                <div class="filters__intro">
                    <h2 class="filters__title" id="filters-title">Подбор по фильтрам</h2>
                    <p class="filters__hint">Выберите фильтры, чтобы быстрее найти нужное вино</p>
                </div>
            </div>
            <div class="filters__grid">
                <div class="filter-box filter-box--wide">
                    <label>Поиск</label>
                    <input id="filter-name" type="text" placeholder="Имя вина">
                </div>
                <div class="filter-box">
                    <label>Страна</label>
                    <div id="filter-country" class="filter-chip-list" role="group" aria-label="Страна"></div>
                </div>
                <div class="filter-box" id="filter-color-box">
                    <label>Цвет</label>
                    <div id="filter-color" class="filter-chip-list filter-chip-list--compact" role="group" aria-label="Цвет"></div>
                </div>
                <div class="filter-box">
                    <label>Сахар</label>
                    <div id="filter-sugar" class="filter-chip-list filter-chip-list--compact" role="group" aria-label="Сладость"></div> 
                </div>
                <div class="filter-box">
                    <label>Регион</label>
                    <div id="filter-region" class="filter-chip-list filter-chip-list--scrollable" role="group" aria-label="Регион"></div>
                </div>
                <div class="filter-box">
                    <label>Сорт винограда</label>
                    <div id="filter-grape" class="filter-chip-list filter-chip-list--scrollable" role="group" aria-label="Виноград"></div>
                </div>
                <!-- Новый фильтр -->
                <div class="filter-box filter-box--checkbox">
                    <label>
                        <input type="checkbox" id="filter-sparkling">
                        Игристое
                    </label>
                </div>
                <div class="filter-box filter-box--checkbox">
                    <label>
                        <input type="checkbox" id="filter-bokal">
                            По бокалам
                    </label>
                </div>  
            </div>
            <div class="filters__actions">
                <button type="button" class="filters__clear" id="filters-clear">
                    Очистить фильтры
                </button>
                <button type="button" class="filters__close" id="filters-close" aria-label="Показать {{ vines|length }} вин">
                    Показать {{ vines|length }} вин
                </button>
            </div>
        </div>
    </div>
</div>



<p>Нажимайте на карточки, чтобы узнать больше &darr;</p>
<div class="wine-list"></div>
<div class="wine-list-sorted"></div>

<p>версия сайта: 4.0 release</p>
<p>winelink сделан с душой <span class="bold">Lavroovich-ем</span></p>

<script>
// словари
const countryMap = {
    russia: "Россия",
    usa: "США",
    ukraine: "Украина",
    france: "Франция",
    italy: "Италия",
    spain: "Испания",
    germany: "Германия",
    new_zealand: "Новая Зеландия",
    georgia: "Грузия",
    brazil: "Бразилия",
    australia: "Австралия",
    aurstria: "Австрия",
    argentina: "Аргентина",
    south_africa: "ЮАР",
    serbia: "Сербия",
    usa: "США",
    chill: "Чили",
    africa: "Африка",
    portugal:"Португалия"
    
};
const colorMap = { red: "Красное", white: "Белое", pink: "Розовое" };
const sugarMap = { dry: "Сухое", semidry: "Полусухое", brut: "Брют", sweet: "Сладкое" , semisweet: "Полусладкое"};

const DEV_TRIGGER_PHRASE = "великий дух база данных 1234";
const DEV_STORAGE_KEY = "winelink-dev-mode";
const devStrip = document.getElementById("dev-strip");
const devAddButton = document.getElementById("dev-add-button");
let devMode = false;

// данные
const allVines = {{ vines|tojson }};
const presetFilters = {{ applyed_filters|tojson }};

allVines.forEach(v => {
    if (!v.sparkling) v.sparkling = "no";
    if (!v.bokal) v.bokal = "no";
});

const list = document.querySelector(".wine-list");
const sortedList = document.querySelector(".wine-list-sorted");

const filterPopover = document.getElementById("filters-popover");
const filterToggleButton = document.getElementById("filters-toggle");
const filterCloseButton = document.getElementById("filters-close");
const filterClearButton = document.getElementById("filters-clear");
const filterBackdrop = document.getElementById("filters-backdrop");
const nameInputEl = document.querySelector("#filter-name");
const sparklingInputEl = document.querySelector("#filter-sparkling");
const bokalInputEl = document.getElementById("filter-bokal");

function setFilterPopupState(isOpen) {
    if (!filterToggleButton) return;
    filterToggleButton.setAttribute("aria-expanded", isOpen ? "true" : "false");
    filterToggleButton.classList.toggle("is-active", isOpen);
    filterToggleButton.textContent = isOpen ? "Закрыть фильтры" : "Открыть фильтры";
}

function openFilters() {
    if (!filterPopover) return;
    filterPopover.classList.add("is-open");
    filterPopover.setAttribute("aria-hidden", "false");
    document.body.classList.add("filters-open");
    setFilterPopupState(true);
    const firstInput = filterPopover.querySelector("#filter-name");
    if (firstInput) {
        setTimeout(() => firstInput.focus(), 60);
    }
}

function closeFilters(restoreFocus = true) {
    if (!filterPopover) return;
    filterPopover.classList.remove("is-open");
    filterPopover.setAttribute("aria-hidden", "true");
    document.body.classList.remove("filters-open");
    setFilterPopupState(false);
    if (restoreFocus && filterToggleButton) {
        setTimeout(() => filterToggleButton.focus(), 0);
    }
}

function formatWineCount(count) {
    const mod100 = count % 100;
    if (mod100 >= 11 && mod100 <= 14) return "вин";
    const mod10 = count % 10;
    if (mod10 === 1) return "вино";
    if (mod10 >= 2 && mod10 <= 4) return "вина";
    return "вин";
}

function updateFilterApplyLabel(count) {
    if (!filterCloseButton) return;
    const suffix = formatWineCount(count);
    const text = "Показать " + count + " " + suffix;
    filterCloseButton.textContent = text;
    filterCloseButton.setAttribute("aria-label", text + " и закрыть фильтры");
}

if (filterToggleButton && filterPopover) {
    filterToggleButton.addEventListener("click", () => {
        if (filterPopover.classList.contains("is-open")) {
            closeFilters(false);
        } else {
            openFilters();
        }
    });

    if (filterCloseButton) {
        filterCloseButton.addEventListener("click", () => closeFilters());
    }

    if (filterBackdrop) {
        filterBackdrop.addEventListener("click", () => closeFilters());
    }

    document.addEventListener("keydown", event => {
        if (event.key === "Escape" && filterPopover.classList.contains("is-open")) {
            closeFilters();
        }
    });

    closeFilters(false);
}

if (filterClearButton) {
    filterClearButton.addEventListener("click", () => {
        resetFilters();
    });
}

const filterContainers = {
    country: document.querySelector("#filter-country"),
    color: document.querySelector("#filter-color"),
    region: document.querySelector("#filter-region"),
    grape: document.querySelector("#filter-grape"),
    sugar: document.querySelector("#filter-sugar")
};

const filterState = {
    name: "",
    sparkling: false,
    bokal: false,
    country: new Set(),
    color: new Set(),
    region: new Set(),
    grape: new Set(),
    sugar: new Set()
};

function syncDevStripVisibility() {
    if (!devStrip) return;
    devStrip.hidden = !devMode;
    devStrip.setAttribute("aria-hidden", devMode ? "false" : "true");
}

function setDevMode(on, reason) {
    devMode = !!on;
    document.body.classList.toggle("dev-mode", devMode);
    syncDevStripVisibility();
    try {
        if (devMode) {
            localStorage.setItem(DEV_STORAGE_KEY, "on");
        } else {
            localStorage.removeItem(DEV_STORAGE_KEY);
        }
    } catch (_) {
        /* localStorage may be unavailable */
    }
    if (devMode && devStrip) {
        const note = devStrip.querySelector(".dev-strip__note");
        if (note && reason === "phrase") {
            note.textContent = "Режим разработчика активирован кодовой фразой.";
        }
    }
}

function restoreDevMode() {
    try {
        if (localStorage.getItem(DEV_STORAGE_KEY) === "on") {
            setDevMode(true, "stored");
        }
    } catch (_) {
        /* ignore storage errors */
    }
}

function checkDevTrigger(value) {
    if (!value) return false;
    const normalized = value.trim().toLowerCase();
    if (normalized === DEV_TRIGGER_PHRASE) {
        setDevMode(true, "phrase");
        if (nameInputEl) {
            nameInputEl.value = "";
        }
        filterState.name = "";
        return true;
    }
    return false;
}

const filterMaps = {
    country: countryMap,
    color: colorMap,
    sugar: sugarMap
};

const filterOptions = {
    country: getUniqueValues(allVines, "country"),
    color: getUniqueValues(allVines, "color"),
    region: getUniqueValues(allVines, "region"),
    grape: getUniqueValues(allVines, "grape"),
    sugar: getUniqueValues(allVines, "sugar")
};

const sortedFilterOptions = {
    country: sortFilterValues(filterOptions.country, filterMaps.country),
    color: sortFilterValues(filterOptions.color, filterMaps.color),
    sugar: sortFilterValues(filterOptions.sugar, filterMaps.sugar),
    grape: sortFilterValues(filterOptions.grape, filterMaps.grape),
    region: sortFilterValues(filterOptions.region)
};

syncDevStripVisibility();
restoreDevMode();

function resetFilters() {
    filterState.name = "";
    filterState.sparkling = false;
    filterState.bokal = false;
    filterState.country = new Set();
    filterState.color = new Set();
    filterState.region = new Set();
    filterState.grape = new Set();
    filterState.sugar = new Set();

    if (nameInputEl) {
        nameInputEl.value = "";
    }
    if (sparklingInputEl) {
        sparklingInputEl.checked = false;
    }
    if (bokalInputEl) {
        bokalInputEl.checked = false;
    }

    filterVines();
}


let filteredVines = allVines.slice();
let priceIdCounter = 0;

updateFilterApplyLabel(filteredVines.length);

function escapeHtml(value) {
    if (value === null || value === undefined) return "";
    return String(value).replace(/[&<>"']/g, char => {
        switch (char) {
            case "&":
                return "&amp;";
            case "<":
                return "&lt;";
            case ">":
                return "&gt;";
            case "\"":
                return "&quot;";
            case "'":
                return "&#39;";
            default:
                return char;
        }
    });
}

function createImageMarkup(v, isSub) {
    if (v.image_url) {
        const safeName = escapeHtml(v.name || "");
        const height = isSub ? 260 : 340;
        return `
            <div class="wine-card__media">
                <img src="${escapeHtml(v.image_url)}" alt="Бутылка ${safeName}" loading="lazy" decoding="async" fetchpriority="low" width="240" height="${height}">
            </div>
        `;
    }
    return '<div class="wine-card__media wine-card__media--placeholder">Фото не загружено</div>';
}

function createWineCardMarkup(v, priceId, isSub = false) {
    const safeName = escapeHtml(v.name || "-");
    const sugar = escapeHtml(sugarMap[v.sugar] || v.sugar || "-");
    const color = escapeHtml(colorMap[v.color] || v.color || "-");
    const country = escapeHtml(countryMap[v.country] || v.country || "-");
    const grapesSource = Array.isArray(v.grape) && v.grape.length ? v.grape : [];
    const grapes = escapeHtml(grapesSource.join(", ") || "-");
    const region = escapeHtml(v.region || "-");
    const priceValue = v.price ? "Цена: " + v.price + " руб." : "Цена: -";
    const priceText = escapeHtml(priceValue);
    const imageMarkup = createImageMarkup(v, isSub);

    return `
        ${imageMarkup}
        <div class="wine-card__body">
            <h3>${safeName}</h3>
            <div class="main-info">${country} / ${color} / ${sugar}</div>
            <div class="extra-info">Регион: ${region} | Сорта: ${grapes}</div>
            <button
                type="button"
                class="toggle-price"
                aria-expanded="false"
                aria-controls="${priceId}"
                data-label-show="Показать цену"
                data-label-hide="Скрыть цену"
            >
                <span aria-hidden="true">руб.</span>
                <span class="toggle-price-label">Показать цену</span>
            </button>
            <div
                class="price is-hidden"
                id="${priceId}"
                role="button"
                tabindex="0"
                aria-hidden="true"
                aria-label="Скрыть цену"
                title="Нажмите, чтобы скрыть цену"
            >${priceText}</div>
            <div class="dev-actions" data-wine-id="${v.id || ""}">
                <a class="dev-action-button" href="/winery/manage?wine_id=${v.id || ""}" target="_blank" rel="noopener" data-edit-link>
                    Редактировать
                </a>
            </div>
        </div>
    `;
}

function getUniqueValues(vines, field) {
    const values = [];
    if (field === "grape") {
        for (let i = 0; i < vines.length; i += 1) {
            const grapeList = Array.isArray(vines[i].grape) ? vines[i].grape : [];
            for (let j = 0; j < grapeList.length; j += 1) {
                values.push(grapeList[j]);
            }
        }
    } else {
        for (let k = 0; k < vines.length; k += 1) {
            const value = vines[k][field];
            if (value) {
                values.push(value);
            }
        }
    }
    return Array.from(new Set(values));
}

function toArray(val) {
    if (val == null) return [];
    return Array.isArray(val) ? val : [val];
}

function sortFilterValues(values, map) {
    const unique = Array.from(new Set((values || []).filter(Boolean)));
    return unique.sort(function (a, b) {
        const textA = map && map[a] ? map[a] : a;
        const textB = map && map[b] ? map[b] : b;
        return textA.toString().toLowerCase().localeCompare(textB.toString().toLowerCase(), "ru");
    });
}

function renderFilterGroup(key, values, skipSort) {
    const container = filterContainers[key];
    if (!container) return;

    const map = filterMaps[key] || {};
    const selected = filterState[key] instanceof Set ? filterState[key] : new Set();
    const sortedValues = skipSort ? values : sortFilterValues(values, map);

    container.innerHTML = "";

    if (!sortedValues || !sortedValues.length) {
        const empty = document.createElement("span");
        empty.className = "filter-chip-empty";
        empty.textContent = "Нет значений для фильтра";
        container.appendChild(empty);
        return;
    }

    const fragment = document.createDocumentFragment();
    for (let i = 0; i < sortedValues.length; i += 1) {
        const value = sortedValues[i];
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "filter-chip";
        chip.dataset.value = value;
        chip.textContent = map[value] || value;
        const isSelected = selected.has(value);
        chip.classList.toggle("is-selected", isSelected);
        chip.setAttribute("aria-pressed", isSelected ? "true" : "false");
        chip.addEventListener("click", function () {
            const set = filterState[key];
            if (!(set instanceof Set)) return;
            if (set.has(value)) {
                set.delete(value);
            } else {
                set.add(value);
            }
            filterVines();
        });
        fragment.appendChild(chip);
    }
    container.appendChild(fragment);
}

function arrayIncludes(list, value) {
    return Array.isArray(list) && list.indexOf(value) !== -1;
}

function countGroupItems(group) {
    if (!group) return 0;
    const keys = Object.keys(group);
    let total = 0;
    for (let i = 0; i < keys.length; i += 1) {
        const items = group[keys[i]];
        total += Array.isArray(items) ? items.length : 0;
    }
    return total;
}

function animateCards(cards) {
    if (!cards || !cards.length) return;
    let index = 0;
    function step() {
        const chunkEnd = Math.min(index + 8, cards.length);
        for (; index < chunkEnd; index += 1) {
            cards[index].classList.add("show");
        }
        if (index < cards.length) {
            window.requestAnimationFrame(step);
        }
    }
    window.requestAnimationFrame(step);
}

function buildWineCard(v, isSub) {
    const card = document.createElement("div");
    card.className = isSub ? "wine-card sub" : "wine-card";
    if (v.sparkling === "yes") {
        card.classList.add("sparkling");
    }
    card.setAttribute("data-pdf", v.pdf_file || "");
    const priceId = "price-" + (++priceIdCounter);
    card.innerHTML = createWineCardMarkup(v, priceId, isSub);
    return card;
}

function findParentByClass(node, className) {
    let current = node;
    while (current && current !== document) {
        if (current.classList && current.classList.contains(className)) {
            return current;
        }
        current = current.parentNode;
    }
    return null;
}

function showPriceForButton(button) {
    const priceId = button.getAttribute("aria-controls");
    let priceElement = priceId ? document.getElementById(priceId) : null;
    if (!priceElement) {
        const card = findParentByClass(button, "wine-card");
        if (card) {
            priceElement = card.querySelector(".price");
        }
    }
    if (!priceElement) return;

    priceElement.classList.remove("is-hidden");
    priceElement.setAttribute("aria-hidden", "false");
    button.classList.add("is-hidden");
    button.setAttribute("aria-expanded", "true");

    const label = button.querySelector(".toggle-price-label");
    const hideLabel = button.getAttribute("data-label-hide");
    if (label && hideLabel) {
        label.textContent = hideLabel;
    }
}

function hidePriceForElement(priceElement, focusBack) {
    const card = findParentByClass(priceElement, "wine-card");
    if (!card) return;

    priceElement.classList.add("is-hidden");
    priceElement.setAttribute("aria-hidden", "true");

    const button = card.querySelector(".toggle-price");
    if (!button) return;

    button.classList.remove("is-hidden");
    button.setAttribute("aria-expanded", "false");

    const label = button.querySelector(".toggle-price-label");
    const showLabel = button.getAttribute("data-label-show");
    if (label && showLabel) {
        label.textContent = showLabel;
    }
    if (focusBack) {
        try {
            button.focus();
        } catch (focusError) {
            /* ignore focus issues */
        }
    }
}

function handleCatalogClick(event) {
    const target = event.target || event.srcElement;
    if (!target) return;

    const devEditButton = findParentByClass(target, "dev-action-button");
    if (devEditButton) {
        event.preventDefault();
        event.stopPropagation();
        const href = devEditButton.getAttribute("href");
        if (href) {
            window.open(href, "_blank");
        }
        return;
    }

    const toggleButton = findParentByClass(target, "toggle-price");
    if (toggleButton) {
        event.preventDefault();
        event.stopPropagation();
        showPriceForButton(toggleButton);
        return;
    }

    const priceElement = findParentByClass(target, "price");
    if (priceElement && !priceElement.classList.contains("is-hidden")) {
        event.preventDefault();
        event.stopPropagation();
        hidePriceForElement(priceElement, true);
        return;
    }

    const card = findParentByClass(target, "wine-card");
    if (!card) return;
    const pdf = card.getAttribute("data-pdf");
    if (pdf) {
        window.open("/vinery/" + pdf, "_blank");
    }
}

function handleCatalogKeydown(event) {
    const target = event.target || event.srcElement;
    if (!target) return;

    const priceElement = findParentByClass(target, "price");
    if (!priceElement || priceElement.classList.contains("is-hidden")) return;

    const key = event.key || event.keyCode;
    if (key === "Enter" || key === 13 || key === " " || key === 32) {
        event.preventDefault();
        hidePriceForElement(priceElement, true);
    }
}

function attachCatalogHandlers(container) {
    if (!container || container.__catalogHandlersAttached) return;
    container.addEventListener("click", handleCatalogClick);
    container.addEventListener("keydown", handleCatalogKeydown);
    container.__catalogHandlersAttached = true;
}

attachCatalogHandlers(list);
attachCatalogHandlers(sortedList);

function renderVines(vines) {
    list.innerHTML = "";
    if (!vines.length) {
        list.innerHTML = '<p style="text-align:center;font-weight:bold;">Нет вин под выбранные фильтры</p>';
        return;
    }

    const fragment = document.createDocumentFragment();
    const cardsToAnimate = [];
    for (let i = 0; i < vines.length; i += 1) {
        const card = buildWineCard(vines[i], false);
        fragment.appendChild(card);
        cardsToAnimate.push(card);
    }
    list.appendChild(fragment);
    animateCards(cardsToAnimate);
}

function renderSortedVines(vines, criterion) {
    sortedList.innerHTML = "";
    if (!criterion || !vines.length) return;

    let primaryKey = "country";
    let secondaryKey = "color";
    let secondaryMap = colorMap;

    const groups = {};
    for (let i = 0; i < vines.length; i += 1) {
        const v = vines[i];
        const pKey = v[primaryKey] || "-";
        const sKey = v[secondaryKey] || "-";
        if (!groups[pKey]) groups[pKey] = {};
        if (!groups[pKey][sKey]) groups[pKey][sKey] = [];
        groups[pKey][sKey].push(v);
    }

    const fragment = document.createDocumentFragment();
    const cardsToAnimate = [];
    const primaryKeys = Object.keys(groups).sort(function (a, b) {
        return countGroupItems(groups[b]) - countGroupItems(groups[a]);
    });

    for (let i = 0; i < primaryKeys.length; i += 1) {
        const pKey = primaryKeys[i];
        const primaryTitle = document.createElement("div");
        primaryTitle.className = "group-title";
        primaryTitle.textContent = countryMap[pKey] || pKey;
        fragment.appendChild(primaryTitle);

        const secondaryKeys = Object.keys(groups[pKey]).sort(function (a, b) {
            return groups[pKey][b].length - groups[pKey][a].length;
        });

        for (let j = 0; j < secondaryKeys.length; j += 1) {
            const sKey = secondaryKeys[j];
            const secondaryTitle = document.createElement("div");
            secondaryTitle.className = "group-title sub";
            secondaryTitle.textContent = secondaryMap[sKey] || sKey;
            fragment.appendChild(secondaryTitle);

            const items = groups[pKey][sKey];
            for (let k = 0; k < items.length; k += 1) {
                const card = buildWineCard(items[k], true);
                fragment.appendChild(card);
                cardsToAnimate.push(card);
            }
        }
    }

    sortedList.appendChild(fragment);
    animateCards(cardsToAnimate);
}

function filterVines() {
    const countries = Array.from(filterState.country);
    const sparklingChecked = !!filterState.sparkling;
    const allowedRegionsRaw = allVines
        .filter(function (v) {
            if (sparklingChecked && v.sparkling !== "yes") return false;
            if (filterState.bokal && v.bokal !== "yes") {
                return false;
            }
            if (countries.length && !arrayIncludes(countries, v.country)) return false;
            return true;
        })
        .map(function (v) { return v.region; })
        .filter(Boolean);
    const allowedRegions = sortFilterValues(allowedRegionsRaw);

    const currentRegions = Array.from(filterState.region);
    const validRegions = currentRegions.filter(function (r) {
        return arrayIncludes(allowedRegions, r);
    });
    if (validRegions.length !== currentRegions.length) {
        filterState.region = new Set(validRegions);
    }

    renderFilterGroup("country", sortedFilterOptions.country, true);
    renderFilterGroup("color", sortedFilterOptions.color, true);
    renderFilterGroup("sugar", sortedFilterOptions.sugar, true);
    renderFilterGroup("grape", sortedFilterOptions.grape, true);
    renderFilterGroup("region", allowedRegions, true);

    const nameFilter = (filterState.name || "").trim().toLowerCase();
    const colors = Array.from(filterState.color);
    const regions = Array.from(filterState.region);
    const grapes = Array.from(filterState.grape);
    const sugars = Array.from(filterState.sugar);

    priceIdCounter = 0;
    filteredVines = allVines.filter(function (v) {
        if (nameFilter) {
            const name = v.name ? v.name.toLowerCase() : "";
            if (!name || name.indexOf(nameFilter) === -1) return false;
        }
        if (countries.length && !arrayIncludes(countries, v.country)) return false;
        if (colors.length && !arrayIncludes(colors, v.color)) return false;
        if (regions.length && !arrayIncludes(regions, v.region)) return false;
        if (grapes.length) {
            const vineGrapes = Array.isArray(v.grape) ? v.grape : [];
            let hasMatch = false;
            for (let i = 0; i < vineGrapes.length; i += 1) {
                if (arrayIncludes(grapes, String(vineGrapes[i]))) {
                    hasMatch = true;
                    break;
                }
            }
            if (!hasMatch) return false;
        }
        if (sugars.length && !arrayIncludes(sugars, v.sugar)) return false;
        if (sparklingChecked && v.sparkling !== "yes") return false;
        if (filterState.bokal && v.bokal !== "yes") return false;
        return true;
    });

    updateFilterApplyLabel(filteredVines.length);
    renderVines(filteredVines);
    updateSorted();
    updateColorHighlight();
}

function updateSorted() {
    if (!filteredVines.length) {
        sortedList.style.display = "none";
        list.style.display = "block";
        return;
    }
    list.style.display = "none";
    sortedList.style.display = "flex";
    renderSortedVines(filteredVines, "country+color");
}

function updateColorHighlight() {
    const colorBox = document.getElementById("filter-color-box");
    if (!colorBox) return;
    colorBox.classList.remove("red-highlight", "white-highlight", "pink-highlight");
    const colors = filterState.color;
    if (colors.has("red")) colorBox.classList.add("red-highlight");
    else if (colors.has("white")) colorBox.classList.add("white-highlight");
    else if (colors.has("pink")) colorBox.classList.add("pink-highlight");
}

function applyPresetFilters() {
    try {
        const pf = presetFilters || {};
        const nameInput = document.querySelector("#filter-name");
        if (nameInput) {
            if (pf.name) {
                nameInput.value = pf.name;
                filterState.name = pf.name;
            } else {
                filterState.name = nameInput.value || "";
            }
            if (checkDevTrigger(nameInput.value || "")) {
                nameInput.value = "";
            }
        }
        const sparklingInput = document.querySelector("#filter-sparkling");
        if (sparklingInput) {
            if ("sparkling" in pf) {
                sparklingInput.checked = !!pf.sparkling;
                filterState.sparkling = !!pf.sparkling;
            } else {
                filterState.sparkling = sparklingInput.checked;
            }
        }
        const bokalPreset = document.getElementById("filter-bokal");
        if (bokalPreset) {
            if ("bokal" in pf) {
                bokalPreset.checked = !!pf.bokal;
                filterState.bokal = !!pf.bokal;
            } else {
                filterState.bokal = bokalPreset.checked;
            }
        }

        ["country", "color", "region", "grape", "sugar"].forEach(key => {
            if (pf[key]) {
                filterState[key] = new Set(toArray(pf[key]).map(String));
            }
        });

        filterVines();
    } catch (e) {
        filterState.name = "";
        filterState.sparkling = false;
        filterState.bokal = false;
        filterState.country = new Set();
        filterState.color = new Set();
        filterState.region = new Set();
        filterState.grape = new Set();
        filterState.sugar = new Set();

        renderFilterGroup("country", filterOptions.country);
        renderFilterGroup("color", filterOptions.color);
        renderFilterGroup("sugar", filterOptions.sugar);
        renderFilterGroup("grape", filterOptions.grape);
        renderFilterGroup("region", filterOptions.region);

        filteredVines = allVines.slice();
        priceIdCounter = 0;
        renderVines(filteredVines);
        updateSorted();
        updateColorHighlight();
    }
}

if (nameInputEl) {
    filterState.name = nameInputEl.value || "";
    checkDevTrigger(filterState.name);
    nameInputEl.addEventListener("input", () => {
        const value = nameInputEl.value || "";
        if (checkDevTrigger(value)) {
            filterVines();
            return;
        }
        filterState.name = value;
        filterVines();
    });
}

if (sparklingInputEl) {
    filterState.sparkling = sparklingInputEl.checked;
    sparklingInputEl.addEventListener("change", () => {
        filterState.sparkling = sparklingInputEl.checked;
        filterVines();
    });
}
if (bokalInputEl) {
    bokalInputEl.addEventListener("change", () => {
        filterState.bokal = bokalInputEl.checked;
        filterVines();
    });
}


applyPresetFilters();

</script>
</main>
</body>
</html>












