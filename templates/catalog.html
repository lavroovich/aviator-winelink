<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Винная Карта — WineLink</title>
<link href="https://fonts.googleapis.com/css?family=Alegreya+SC:500,700&display=swap" rel="stylesheet">
<style>
body { margin:0; padding:0; min-height:100vh; font-family:'Alegreya SC', sans-serif; background:#faf7f0; color:#333; display:flex; flex-direction:column; }
header { width:100%; display:flex; justify-content:center; padding:24px 18px 12px; background:transparent; border-bottom:none; position:sticky; top:0; z-index:20; }
.logo-container {
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    padding:18px 26px;
    margin:0 auto;
    border-radius:20px;
    border:1px solid rgba(111,10,10,0.12);
    background:white;
    box-shadow:0 12px 30px rgba(111,10,10,0.08);
}
.logo-container img { display:block; max-width:150px; height:auto; }
main { flex:1; padding:15px; }
h1 { font-size:1.6rem; text-align:center; margin-bottom:15px; background: #6f0a0a; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

.filters {
    position:relative;
    display:flex;
    flex-direction:column;
    gap:18px;
    padding:22px 24px 24px;
    margin-bottom:20px;
    border-radius:20px;
    border:1px solid rgba(111,10,10,0.12);
    background:linear-gradient(140deg, rgba(255,244,235,0.95) 0%, rgba(255,255,255,0.98) 55%, #ffffff 100%);
    box-shadow:0 12px 30px rgba(111,10,10,0.08);
    overflow:hidden;
    z-index:0;
}
.filters::after {
    content:'';
    position:absolute;
    inset:0;
    background:radial-gradient(circle at 85% 15%, rgba(111,10,10,0.08), transparent 55%);
    pointer-events:none;
    z-index:0;
}
.filters__header,
.filters__grid {
    position:relative;
    z-index:1;
}
.filters__header {
    display:flex;
    flex-wrap:wrap;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
}
.filters__title {
    margin:0;
    font-size:1.15rem;
    font-weight:700;
    color:#6f0a0a;
    letter-spacing:0.02em;
}
.filters__hint {
    margin:4px 0 0;
    font-size:0.78rem;
    color:rgba(51,51,51,0.72);
    max-width:28rem;
    line-height:1.4;
}
.filters__grid {
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));
    gap:14px 18px;
}
.filter-box {
    display:flex;
    flex-direction:column;
    gap:6px;
    padding:12px 14px;
    border-radius:14px;
    background:rgba(255,255,255,0.9);
    border:1px solid rgba(111,10,10,0.12);
    box-shadow:0 2px 6px rgba(111,10,10,0.06);
    transition:border-color 0.25s ease, box-shadow 0.25s ease, transform 0.25s ease, background 0.25s ease;
}
.filter-box:hover,
.filter-box:focus-within {
    border-color:rgba(111,10,10,0.35);
    box-shadow:0 6px 16px rgba(111,10,10,0.1);
    transform:translateY(-2px);
    background:#ffffff;
}
.filter-box label {
    font-size:0.75rem;
    text-transform:uppercase;
    letter-spacing:0.06em;
    font-weight:700;
    color:#6f0a0a;
    display:flex;
    flex-direction:column;
    gap:6px;
}
.filter-box select,
.filter-box input[type="text"] {
    padding:8px 34px 8px 12px;
    font-size:0.92rem;
    border-radius:10px;
    border:1px solid rgba(111,10,10,0.18);
    background:#ffffff;
    font-family:inherit;
    color:#2f2f2f;
    transition:border-color 0.2s ease, box-shadow 0.2s ease;
    box-shadow:inset 0 1px 2px rgba(111,10,10,0.08);
    appearance:none;
    width:100%;
    box-sizing:border-box;
}
.filter-box select:not([multiple]) {
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='10' viewBox='0 0 14 10'%3E%3Cpath fill='none' stroke='%236f0a0a' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round' d='M1 2.5 7 7.5 13 2.5'/%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position:right 12px center;
    background-size:14px 10px;
    padding-right:40px;
}
.filter-box select:focus,
.filter-box input[type="text"]:focus {
    border-color:#6f0a0a;
    box-shadow:0 0 0 3px rgba(111,10,10,0.12);
    outline:none;
}
.filter-box select[multiple] {
    min-height:120px;
    padding-right:12px;
}
.filter-box--wide {
    grid-column:span 2;
}
.filter-box--checkbox {
    padding:12px;
}
.filter-box--checkbox label {
    flex-direction:row;
    align-items:center;
    gap:10px;
    text-transform:none;
    letter-spacing:0;
    font-size:0.9rem;
    font-weight:600;
    color:#333;
}
.filter-box--checkbox input[type="checkbox"] {
    margin:0;
    width:18px;
    height:18px;
    cursor:pointer;
    accent-color:#6f0a0a;
}
.filter-box.red-highlight {
    background:rgba(255,225,225,0.92);
    border-color:rgba(168,40,40,0.55);
}
.filter-box.white-highlight {
    background:rgba(255,255,221,0.92);
    border-color:rgba(179,165,56,0.55);
}
.filter-box.pink-highlight {
    background:rgba(255,220,235,0.92);
    border-color:rgba(182,101,133,0.55);
}

@media (max-width:900px) {
    .filters {
        padding:18px 18px 20px;
    }
    .filter-box--wide {
        grid-column:span 1;
    }
}

@media (max-width:600px) {
    .filters__grid {
        grid-template-columns:1fr;
    }
    .filters::after {
        background:radial-gradient(circle at 90% 10%, rgba(111,10,10,0.1), transparent 45%);
    }
}

.wine-list-sorted .group-title {
    font-weight:700;
    font-size:1.1rem;
    margin:12px 0 6px;
    color:#2c3e50;
    border-left:4px solid #2980b9;
    padding-left:8px;
    background:#ecf0f1;
    border-radius:4px;
}
.wine-list-sorted .group-title.sub {
    font-weight:600;
    font-size:0.95rem;
    margin:6px 0 4px 20px;
    color:#34495e;
    border-left:3px solid #3498db;
    padding-left:6px;
    background:#f7f9fa;
}

.wine-list, .wine-list-sorted { display:flex; flex-direction:column; gap:10px; }

.wine-card {
    position:relative;
    display:flex;
    flex-direction:column;
    gap:12px;
    padding:20px 22px 22px;
    background:linear-gradient(140deg, rgba(255,244,235,0.96) 0%, rgba(255,255,255,0.98) 60%, #ffffff 100%);
    border-radius:20px;
    border:1px solid rgba(111,10,10,0.14);
    box-shadow:0 14px 32px rgba(111,10,10,0.08);
    cursor:pointer;
    transition:transform 0.28s ease, box-shadow 0.28s ease, opacity 0.4s ease, border-color 0.28s ease;
    opacity:0;
    transform:translateY(18px) scale(0.98);
    overflow:hidden;
}
.wine-card::after {
    content:'';
    position:absolute;
    inset:0;
    background:radial-gradient(circle at 85% 10%, rgba(111,10,10,0.08), transparent 55%);
    pointer-events:none;
    opacity:0.85;
}
.wine-card.show {
    opacity:1;
    transform:translateY(0) scale(1);
}
.wine-card:hover,
.wine-card:focus-within {
    transform:translateY(-4px) scale(1.01);
    box-shadow:0 18px 36px rgba(111,10,10,0.12);
    border-color:rgba(111,10,10,0.32);
}
.wine-card__media {
    position:relative;
    width:100%;
    height:220px;
    border-radius:16px;
    background:radial-gradient(circle at 30% 25%, rgba(255,229,210,0.65), rgba(255,255,255,0.95) 60%);
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    border:1px dashed rgba(111,10,10,0.18);
    box-shadow:inset 0 0 30px rgba(111,10,10,0.06);
    z-index:1;
}
.wine-card__media img {
    max-width:90%;
    max-height:90%;
    width:auto;
    height:auto;
    object-fit:contain;
    transform:translateZ(0);
    filter:drop-shadow(0 8px 16px rgba(111,10,10,0.18));
}
.wine-card__media--placeholder {
    font-size:0.85rem;
    font-weight:600;
    color:rgba(111,10,10,0.6);
    text-transform:uppercase;
    letter-spacing:0.08em;
    text-align:center;
    padding:0 16px;
}
.wine-card__body {
    position:relative;
    z-index:1;
    display:flex;
    flex-direction:column;
    gap:8px;
}
.wine-card h3 {
    font-size:1.05rem;
    margin:0;
    font-weight:700;
    color:#4c1b1b;
}
.wine-card .main-info {
    font-size:0.92rem;
    font-weight:600;
    color:#6f0a0a;
}
.wine-card .extra-info {
    font-size:0.85rem;
    color:rgba(49,49,49,0.75);
    line-height:1.45;
}
.wine-card .toggle-price {
    align-self:flex-start;
    display:flex;
    align-items:center;
    gap:8px;
    padding:8px 18px;
    background:rgba(111,10,10,0.08);
    border:1px solid rgba(111,10,10,0.25);
    border-radius:999px;
    color:#6f0a0a;
    cursor:pointer;
    font-size:0.85rem;
    font-family:inherit;
    letter-spacing:0.02em;
    transition:transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
}
.wine-card .toggle-price:hover {
    transform:translateY(-1px);
    background:rgba(111,10,10,0.12);
    box-shadow:0 6px 14px rgba(111,10,10,0.18);
}
.wine-card .toggle-price:focus {
    outline:2px solid rgba(111,10,10,0.28);
    outline-offset:2px;
}
.wine-card .toggle-price.is-hidden {
    display:none;
}
.wine-card .price {
    font-size:1.1rem;
    font-weight:700;
    color:#501010;
    display:block;
    margin:4px 0 2px;
    cursor:pointer;
    transition:color 0.2s ease;
}
.wine-card .price:focus-visible {
    outline:2px solid rgba(111,10,10,0.28);
    outline-offset:2px;
}
.wine-card .price:hover {
    color:#6f0a0a;
}
.wine-card .price.is-hidden {
    display:none;
}

/* выделяем игристое бордюром */
.wine-card.sparkling {
    border-color:rgba(255,215,0,0.55);
    box-shadow:0 18px 36px rgba(255,197,40,0.18);
}

.wine-card.sub {
    padding:18px;
    font-size:0.85rem;
    border-radius:18px;
    box-shadow:0 10px 24px rgba(111,10,10,0.07);
    gap:10px;
}
.wine-card.sub .wine-card__media {
    height:190px;
}
.wine-card.sub.show {
    transform:translateY(0) scale(0.99);
}
.wine-card.sub h3 {
    font-size:0.98rem;
}
.wine-card.sub .main-info {
    font-size:0.88rem;
}
.wine-card.sub .extra-info {
    font-size:0.8rem;
}
.bold { font-weight:bold; }
</style>
</head>
<body>
<header>
    <div class="logo-container">
        <img src="{{ url_for('static', filename='logo.jpg') }}" alt="VineLink">
    </div>
</header>
<main>
<h1>Винная Карта</h1>

<div class="filters">
    <div class="filters__header">
        <h2 class="filters__title">Подбор по параметрам</h2>
        <p class="filters__hint">Выберите параметры, чтобы быстрее найти нужное вино внутри нашей коллекции.</p>
    </div>
    <div class="filters__grid">
        <div class="filter-box filter-box--wide">
            <label>Поиск</label>
            <input id="filter-name" type="text" placeholder="Имя вина">
        </div>
        <div class="filter-box">
            <label>Страна</label>
            <select id="filter-country" multiple></select>
        </div>
        <div class="filter-box" id="filter-color-box">
            <label>Цвет</label>
            <select id="filter-color" multiple></select>
        </div>
        <div class="filter-box">
            <label>Сахар</label>
            <select id="filter-sugar" multiple></select> 
        </div>
        <div class="filter-box">
            <label>Регион</label>
            <select id="filter-region" multiple></select>
        </div>
        <div class="filter-box">
            <label>Сорт винограда</label>
            <select id="filter-grape" multiple></select>
        </div>
        <!-- Новый фильтр -->
        <div class="filter-box filter-box--checkbox">
            <label>
                <input type="checkbox" id="filter-sparkling">
                Игристое
            </label>
        </div>
    </div>
</div>

<p>Нажимайте на карточки, чтобы узнать больше &darr;</p>
<div class="wine-list"></div>
<div class="wine-list-sorted"></div>

<p>версия сайта: 2.1</p>
<p>winelink сделан с душой <span class="bold">Lavroovich-ем</span></p>

<script>
// мапы
const countryMap = { 
    russia:"🇷🇺 Россия", usa:"🇺🇸 США", ukraine:"🇺🇦 Украина", france:"🇫🇷 Франция", italy:"🇮🇹 Италия", 
    spain:"🇪🇸 Испания", germany:"🇩🇪 Германия", new_zealand:"🇳🇿 Новая Зеландия", georgia:"🇬🇪 Грузия", 
    brazil:"🇧🇷 Бразилия", australia:"🇦🇺 Австралия", aurstria:"🇦🇹 Австрия", argentina:"🇦🇷 Аргентина", 
    south_africa:"🇿🇦 Южная Африка", serbia: "🇷🇸 Сербия" 
};
const colorMap = { red:"Красное", white:"Белое", pink:"Розовое" };
const sugarMap = { dry:"Сухое", semidry:"Полусухое", brut: "Брют" , sweet:"Сладкое" };

// получаем данные из шаблона
const allVines = {{ vines|tojson }};
const presetFilters = {{ applyed_filters|tojson }};

// фикс для undefined sparkling
allVines.forEach(v => {
    if(!v.sparkling) v.sparkling = "no"; // если undefined, подставляем no
});

const list = document.querySelector('.wine-list');
const sortedList = document.querySelector('.wine-list-sorted');

const selects = { 
    country: document.querySelector('#filter-country'), 
    color: document.querySelector('#filter-color'), 
    region: document.querySelector('#filter-region'), 
    grape: document.querySelector('#filter-grape'),
    sugar: document.querySelector('#filter-sugar')
};

let filteredVines = allVines.slice();
let priceIdCounter = 0;

function escapeHtml(value){
    if(value === null || value === undefined) return '';
    return String(value).replace(/[&<>"']/g, char => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
    })[char]);
}

function createImageMarkup(v, isSub){
    if(v.image_url){
        const safeName = escapeHtml(v.name || '');
        const height = isSub ? 260 : 340;
        return `
            <div class=\"wine-card__media\">
                <img src=\"${escapeHtml(v.image_url)}\" alt=\"Бутылка ${safeName}\" loading=\"lazy\" decoding=\"async\" fetchpriority=\"low\" width=\"240\" height=\"${height}\">
            </div>
        `;
    }
    return '<div class="wine-card__media wine-card__media--placeholder">Фотография Не Найдена</div>';
}

function createWineCardMarkup(v, priceId, isSub=false){
    const safeName = escapeHtml(v.name || '—');
    const sugar = escapeHtml(sugarMap[v.sugar] || v.sugar || '—');
    const color = escapeHtml(colorMap[v.color] || v.color || '—');
    const country = escapeHtml(countryMap[v.country] || v.country || '—');
    const grapesList = v.grape && v.grape.length ? v.grape.join(', ') : '—';
    const grapes = escapeHtml(grapesList);
    const region = escapeHtml(v.region || '—');
    const priceText = escapeHtml(v.price ? `Цена: ${v.price} ₽` : 'Цена: —');
    const imageMarkup = createImageMarkup(v, isSub);

    return `
        ${imageMarkup}
        <div class=\"wine-card__body\">
            <h3>${safeName}</h3>
            <div class=\"main-info\">${country} • ${color} • ${sugar}</div>
            <div class=\"extra-info\">Регион: ${region} | Сорт винограда: ${grapes}</div>
            <button type=\"button\" class=\"toggle-price\" aria-expanded=\"false\" aria-controls=\"${priceId}\">
                <span aria-hidden=\"true\">👁</span>
                <span class=\"toggle-price-label\">Показать цену</span>
            </button>
            <div class=\"price is-hidden\" id=\"${priceId}\" role=\"button\" tabindex=\"0\" aria-hidden=\"true\" aria-label=\"Скрыть цену\" title=\"Нажмите, чтобы скрыть цену\">${priceText}</div>
        </div>
    `;
}

// функции утилиты
function getUniqueValues(vines, field){ 
    if(field==="grape") return [...new Set(vines.flatMap(v=>v.grape||[]))]; 
    return [...new Set(vines.map(v=>v[field]).filter(x=>x))]; 
}

function getSelectedValues(select){ 
    return Array.from(select.selectedOptions).map(o=>o.value); 
}

function populateSelect(select, values, map){ 
    const current = getSelectedValues(select);
    select.innerHTML = '';
    values.sort((a,b)=>{
        const textA = (map ? map[a] || a : a).toString().toLowerCase();
        const textB = (map ? map[b] || b : b).toString().toLowerCase();
        return textA.localeCompare(textB, 'ru');
    });
    values.forEach(val=>{
        const option=document.createElement('option');
        option.value=val;
        option.textContent=map?map[val]||val:val;
        if(current.includes(val)) option.selected=true;
        select.appendChild(option);
    });
}

function animateCards(cards){ 
    cards.forEach((c,i)=>setTimeout(()=>c.classList.add('show'), i*50)); 
}

function toArray(val){
    if(val==null) return [];
    if(Array.isArray(val)) return val;
    return [val];
}

function selectValues(select, values){
    const vals = new Set(toArray(values).map(String));
    Array.from(select.options).forEach(opt=>{
        opt.selected = vals.has(String(opt.value));
    });
}

function renderVines(vines){
    list.innerHTML='';
    if(!vines.length){ 
        list.innerHTML='<p style="text-align:center;font-weight:bold;">Всё — не найдено 😢</p>'; 
        return; 
    }
    const cards=[];
    vines.forEach(v=>{
        const card = document.createElement('div'); 
        card.className='wine-card';
        if(v.sparkling==="yes") card.classList.add('sparkling'); // выделяем игристое
        card.dataset.pdf=v.pdf_file;
        const priceId = `price-${++priceIdCounter}`;
        card.innerHTML = createWineCardMarkup(v, priceId);
        list.appendChild(card); 
        cards.push(card);
        setupPriceToggle(card);
        card.addEventListener('click',()=>window.open('/vinery/'+v.pdf_file,'_blank'));
    });
    requestAnimationFrame(()=>animateCards(cards));
}

function setupPriceToggle(card){
    const button = card.querySelector('.toggle-price');
    const priceElement = card.querySelector('.price');
    if(!button || !priceElement) return;
    const label = button.querySelector('.toggle-price-label');
    priceElement.setAttribute('aria-hidden', priceElement.classList.contains('is-hidden') ? 'true' : 'false');

    const showPrice = () => {
        priceElement.classList.remove('is-hidden');
        priceElement.setAttribute('aria-hidden','false');
        button.classList.add('is-hidden');
        button.setAttribute('aria-expanded','true');
        if(label) label.textContent = 'Показать цену';
    };

    const hidePrice = () => {
        priceElement.classList.add('is-hidden');
        priceElement.setAttribute('aria-hidden','true');
        button.classList.remove('is-hidden');
        button.setAttribute('aria-expanded','false');
        if(label) label.textContent = 'Показать цену';
    };

    button.addEventListener('click', event => {
        event.stopPropagation();
        event.preventDefault();
        showPrice();
    });

    priceElement.addEventListener('click', event => {
        event.stopPropagation();
        event.preventDefault();
        hidePrice();
        button.focus();
    });

    priceElement.addEventListener('keydown', event => {
        if(event.key === 'Enter' || event.key === ' '){
            event.preventDefault();
            hidePrice();
            button.focus();
        }
    });
}

function filterVines(){
    list.innerHTML=''; 
    sortedList.innerHTML='';

    const name = document.querySelector('#filter-name').value.toLowerCase();
    const countries = getSelectedValues(selects.country);
    const colors = getSelectedValues(selects.color);
    let regions = getSelectedValues(selects.region);
    const grapes = getSelectedValues(selects.grape);
    const sugars = getSelectedValues(selects.sugar);
    const sparklingChecked = document.querySelector('#filter-sparkling').checked;

    // вычисляем доступные регионы после фильтра
    const allowedRegions = allVines
        .filter(v => (!sparklingChecked || v.sparkling==="yes") &&
                     (countries.length===0 || countries.includes(v.country)))
        .map(v=>v.region)
        .filter(r=>r);
    regions = regions.filter(r=>allowedRegions.includes(r));

    filteredVines = allVines.filter(v=>
        (!name || v.name.toLowerCase().includes(name)) &&
        (countries.length===0 || countries.includes(v.country)) &&
        (colors.length===0 || colors.includes(v.color)) &&
        (regions.length===0 || regions.includes(v.region)) &&
        (grapes.length===0 || (v.grape||[]).some(g=>grapes.includes(g))) &&
        (sugars.length===0 || sugars.includes(v.sugar)) &&
        (!sparklingChecked || v.sparkling==="yes") // фильтр игристого
    );

    populateSelect(selects.region, [...new Set(allowedRegions)]);
    renderVines(filteredVines);
    updateSorted();
}

function renderSortedVines(vines,criterion){
    sortedList.innerHTML=''; 
    if(!criterion) return;

    let primaryKey='country', secondaryKey='color', secondaryMap=colorMap;

    const groups={};
    vines.forEach(v=>{
        const pKey = v[primaryKey]||'—';
        const sKey = v[secondaryKey]||'—';
        groups[pKey] = groups[pKey]||{};
        groups[pKey][sKey] = groups[pKey][sKey]||[];
        groups[pKey][sKey].push(v);
    });

    Object.keys(groups).sort((a,b)=>Object.values(groups[b]).flat().length-Object.values(groups[a]).flat().length).forEach(pKey=>{
        const primaryTitle = document.createElement('div'); 
        primaryTitle.className='group-title'; 
        primaryTitle.textContent = countryMap[pKey]||pKey;
        sortedList.appendChild(primaryTitle);

        Object.keys(groups[pKey]).sort((a,b)=>groups[pKey][b].length-groups[pKey][a].length).forEach(sKey=>{
            const secondaryTitle = document.createElement('div'); 
            secondaryTitle.className='group-title sub'; 
            secondaryTitle.textContent = secondaryMap[sKey]||sKey;
            sortedList.appendChild(secondaryTitle);

            groups[pKey][sKey].forEach(v=>{
                const card=document.createElement('div'); 
                card.className='wine-card sub';
                if(v.sparkling==="yes") card.classList.add('sparkling'); // игристое
                const priceId = `price-${++priceIdCounter}`;
                card.innerHTML = createWineCardMarkup(v, priceId, true);
                sortedList.appendChild(card);
                setupPriceToggle(card);
                card.addEventListener('click',()=>window.open('/vinery/'+v.pdf_file,'_blank'));
                requestAnimationFrame(()=>card.classList.add('show'));
            });
        });
    });
}

function updateSorted(){ 
    list.style.display='none'; 
    sortedList.style.display='flex'; 
    renderSortedVines(filteredVines,"country+color");
}

function updateColorHighlight(){
    const colorBox=document.getElementById('filter-color-box');
    colorBox.classList.remove("red-highlight","white-highlight","pink-highlight");
    const colors=getSelectedValues(selects.color);
    if(colors.includes("red")) colorBox.classList.add("red-highlight");
    else if(colors.includes("white")) colorBox.classList.add("white-highlight");
    else if(colors.includes("pink")) colorBox.classList.add("pink-highlight");
}

// populate selects
populateSelect(selects.country,getUniqueValues(allVines,'country'),countryMap);
populateSelect(selects.color,getUniqueValues(allVines,'color'),colorMap);
populateSelect(selects.region,getUniqueValues(allVines,'region'));
populateSelect(selects.grape,getUniqueValues(allVines,'grape'));
populateSelect(selects.sugar,getUniqueValues(allVines,'sugar'),sugarMap);

// применяем пресеты из applyed_filters (если переданы)
function applyPresetFilters(){
    try {
        const pf = presetFilters || {};
        if(pf.name) document.querySelector('#filter-name').value = pf.name;
        if('sparkling' in pf) document.querySelector('#filter-sparkling').checked = !!pf.sparkling;

        if(pf.country) selectValues(selects.country, pf.country);
        if(pf.color) selectValues(selects.color, pf.color);
        if(pf.sugar) selectValues(selects.sugar, pf.sugar);
        // регион зависит от страны/игристого, выставим после первой фильтрации
        // но если пришел регион — сохраним и попробуем применить после пересборки списка регионов
        const pendingRegion = toArray(pf.region);

        // первая фильтрация применит страну/цвет/сахар/игристое/имя
        filterVines();
        updateColorHighlight();

        if(pendingRegion.length){
            // после пересборки регионов выберем нужные и снова отфильтруем
            selectValues(selects.region, pendingRegion);
            filterVines();
        }
    } catch(e){
        // если что-то не так с пресетом — просто отрисуем все вина
        renderVines(allVines);
        updateSorted();
    }
}

applyPresetFilters();

// события
document.querySelectorAll('.filters input, .filters select').forEach(el=>{
    el.addEventListener('input',()=>{
        filterVines(); 
        updateColorHighlight();
    });
});
</script>
</main>
</body>
</html>
