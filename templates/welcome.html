<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Авиатор - Винная Карта</title>
  <link href="https://fonts.googleapis.com/css?family=Alegreya+SC:500,700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing:border-box; }
    body {
      margin:0; padding:0; min-height:100vh;
      font-family:'Alegreya SC', sans-serif;
      background:#faf7f0; color:#333;
      display:flex; flex-direction:column;
    }
    header {
      width:100%;
      display:flex;
      justify-content:center;
      padding:24px 18px 12px;
      background:transparent;
      border-bottom:none;
      position:sticky;
      top:0;
      z-index:20;
    }
    .logo-container {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      padding:18px 26px;
      margin:0 auto;
      border-radius:20px;
      border:1px solid rgba(111,10,10,0.12);
      background:white;
      box-shadow:0 12px 30px rgba(111,10,10,0.08);
    }
    .logo-container img {
      display:block;
      max-width:150px;
      height:auto;
      cursor:pointer;
    }
    main {
      flex:1;
      width:100%;
      max-width:1120px;
      margin:0 auto;
      padding:28px 18px 48px;
      display:flex;
      flex-direction:column;
      gap:28px;
    }
    h1 {
      margin:0;
      font-size:1.9rem;
      text-align:center;
      background:#6f0a0a;
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .welcome-panels {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
      gap:20px;
    }
    .panel {
      position:relative;
      padding:22px 24px;
      border-radius:18px;
      border:1px solid rgba(111,10,10,0.12);
      background:linear-gradient(140deg, rgba(255,244,235,0.95) 0%, rgba(255,255,255,0.98) 65%, #ffffff 100%);
      box-shadow:0 12px 30px rgba(111,10,10,0.08);
      overflow:hidden;
    }
    .panel::after {
      content:'';
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 85% 15%, rgba(111,10,10,0.08), transparent 55%);
      pointer-events:none;
    }
    .panel__body {
      position:relative;
      z-index:1;
    }
    .lead-text {
      margin:0;
      font-size:1.1rem;
      line-height:1.45;
      color:rgba(51,51,51,0.9);
    }
    .status-panel {
      display:flex;
      flex-direction:column;
      gap:10px;
      font-size:0.9rem;
      background:linear-gradient(160deg, #1e293b 0%, #0f172a 55%, #0b1120 100%);
      color:#e2e8f0;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
      border:1px solid rgba(255,255,255,0.08);
      box-shadow:0 18px 36px rgba(15,23,42,0.28);
    }
    .status-panel::after {
      background:radial-gradient(circle at 85% 20%, rgba(148,163,184,0.18), transparent 60%);
    }
    .status-panel.hidden { display:none; }
    .status-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .status-row .label { color:#94a3b8; }
    .status-row .val { color:#e2e8f0; }
    .status-row .ok { color:#10b981; }
    .status-row .warn { color:#fbbf24; }
    .status-row .err { color:#ef4444; }
    .tiles {
      display:grid;
      gap:18px;
      grid-template-columns:repeat(auto-fit, minmax(230px, 1fr));
    }
    .tile {
      display:block;
      position:relative;
      text-decoration:none;
      color:inherit;
      padding:22px 24px;
      border-radius:18px;
      border:1px solid rgba(111,10,10,0.12);
      background:linear-gradient(150deg, rgba(255,244,235,0.95) 0%, rgba(255,255,255,0.98) 58%, #ffffff 100%);
      box-shadow:0 10px 24px rgba(111,10,10,0.08);
      transition:transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
      overflow:hidden;
    }
    .tile::after {
      content:'';
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 85% 20%, rgba(111,10,10,0.08), transparent 60%);
      transition:opacity 0.25s ease;
      pointer-events:none;
    }
    .tile:hover {
      transform:translateY(-4px);
      box-shadow:0 16px 32px rgba(111,10,10,0.12);
      border-color:rgba(111,10,10,0.35);
    }
    .tile:hover::after { opacity:0.6; }
    .tile h2 { margin:0 0 8px; font-size:1.28rem; position:relative; z-index:1; }
    .tile .hint { margin:0; font-size:0.96rem; opacity:0.8; position:relative; z-index:1; }
    .tile.red::after { background:radial-gradient(circle at 85% 20%, rgba(111,10,10,0.2), transparent 60%); }
    .tile.white::after { background:radial-gradient(circle at 85% 20%, rgba(227,192,74,0.22), transparent 60%); }
    .tile.pink::after { background:radial-gradient(circle at 85% 20%, rgba(215,94,140,0.22), transparent 60%); }
    .tile.sparkling::after { background:radial-gradient(circle at 85% 20%, rgba(217,180,28,0.28), transparent 60%); }
    .tile.all::after { background:radial-gradient(circle at 85% 20%, rgba(51,51,51,0.16), transparent 60%); }
    .foot {
      text-align:center;
      margin-top:8px;
      font-size:0.92rem;
      color:rgba(51,51,51,0.72);
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-container" title="Трипл-тап: показать состояние">
      <img id="app-logo" src="{{ url_for('static', filename='logo.jpg') }}" alt="logo">
    </div>
  </header>
  <main>
    <h1>Винная Карта</h1>
    <div class="welcome-panels">
      <div class="panel">
      </div>
      <div id="sys-status" class="panel status-panel hidden" aria-label="Состояние системы">
        <div class="panel__body">
          <div class="status-row"><span class="label">ENV</span><span class="val" id="st-env">—</span></div>
          <div class="status-row"><span class="label">DB</span><span class="val" id="st-db">—</span></div>
          <div class="status-row"><span class="label">Каталог</span><span class="val" id="st-vines">—</span></div>
          <div class="status-row"><span class="label">Цвета</span><span class="val" id="st-colors">—</span></div>
          <div class="status-row"><span class="label">География</span><span class="val" id="st-geo">—</span></div>
          <div class="status-row"><span class="label">Сорта</span><span class="val" id="st-grapes">—</span></div>
          <div class="status-row"><span class="label">Сладость</span><span class="val" id="st-sugars">—</span></div>
          <div class="status-row"><span class="label" id="st-pdfs-label">WEBP</span><span class="val" id="st-pdfs">—</span></div>
          <div class="status-row"><span class="label">Версия</span><span class="val" id="st-ver">—</span></div>
        </div>
      </div>
    </div>

    <div class="tiles">
      <a class="tile red" href="/winery/?applyed_filters=%7B%22color%22%3A%5B%22red%22%5D%7D">
        <h2>🍷 Красные вина</h2>
      </a>
      <a class="tile white" href="/winery/?applyed_filters=%7B%22color%22%3A%5B%22white%22%5D%7D">
        <h2>🥂 Белые вина</h2>
      </a>
      <a class="tile pink" href="/winery/?applyed_filters=%7B%22color%22%3A%5B%22pink%22%5D%7D">
        <h2>🌸 Розовые вина</h2>
      </a>
      <a class="tile sparkling" href="/winery/?applyed_filters=%7B%22sparkling%22%3Atrue%7D">
        <h2>🍾✨ Игристые вина</h2>
      </a>
      <a class="tile all" href="/winery/">
        <h2>📚 Все вина</h2>
      </a>
    </div>

    <p class="foot">версия сайта: 4.0 release • winelink сделан с душой Lavroovich-ем</p>
  </main>

  <script>
    // Triple‑tap/клик по логотипу: показываем/скрываем панель статуса и подтягиваем реальные значения
    (function(){
      const logo = document.getElementById('app-logo');
      const panel = document.getElementById('sys-status');
      let taps = [];
      let loaded = false;

      function registerTap(){
        const now = Date.now();
        taps = taps.filter(t => now - t < 600);
        taps.push(now);
        if (taps.length >= 3) {
          taps = [];
          panel.classList.toggle('hidden');
          if (!panel.classList.contains('hidden') && !loaded) {
            loaded = true;
            fetchStatus();
          }
        }
      }

      // Универсально: pointerup работает и для мыши, и для тачей
      logo.addEventListener('pointerup', registerTap);

            async function fetchStatus(){
        try {
          const res = await fetch('/status.json', { cache: 'no-store' });
          const data = await res.json();
          const details = data.details || {};
          const ruColor = { red: 'кр.', white: 'бел.', pink: 'роз.' };
          const envHuman = data.env === 'vercel' ? 'production (vercel)' : 'local';
          const dbMode = data.db_mode === 'ro' ? 'read-only' : 'read-write';
          const colors = details.colors || {};
          const valueOr = (val, fallback) => (val === undefined || val === null ? fallback : val);
          const colorStr = Object.keys(colors).length
            ? Object.entries(colors)
                .map(([k, v]) => `${ruColor[k] || k}: ${v}`)
                .join(', ')
            : '-';
          const sugars = (details.sugars_present || []).join(', ');
          const countriesDisplay = valueOr(details.countries_total, '-');
          const regionsDisplay = valueOr(details.regions_total, '-');
          const vinesTotal = valueOr(details.vines_total, '-');
          const sparklingCount = valueOr(details.sparkling_yes, 0);
          const geo = `стран: ${countriesDisplay}, регионов: ${regionsDisplay}`;
          const vines = `${vinesTotal} (игристых: ${sparklingCount})`;
          const assetExt = (details.pdfs_extension || '.pdf').replace('.', '').toUpperCase();
          const assetDir = details.pdfs_dir_name || (assetExt === 'WEBP' ? 'webp' : 'pdfs');
          const pdfMissing = details.pdfs_missing || [];
          const pdfExtra = details.pdfs_extra || [];
          const pdfsInDir = valueOr(details.pdfs_in_dir, '-');
          const filesSummary = `В папке ${assetDir}: ${pdfsInDir}, недостаёт: ${pdfMissing.length}, лишние: ${pdfExtra.length}`;

          document.getElementById('st-env').textContent = `${envHuman}, DB ${dbMode}`;
          document.getElementById('st-db').innerHTML = data.db_connected
            ? '<span class="ok">connected</span>'
            : '<span class="err">disconnected</span>';
          document.getElementById('st-vines').textContent = vines;
          document.getElementById('st-colors').textContent = colorStr;
          document.getElementById('st-geo').textContent = geo;
          document.getElementById('st-grapes').textContent = `${valueOr(details.grapes_total, '-')} сортов`;
          document.getElementById('st-sugars').textContent = sugars || '-';
          const labelEl = document.getElementById('st-pdfs-label');
          if (labelEl) labelEl.textContent = assetExt;
          const pdfEl = document.getElementById('st-pdfs');
          pdfEl.textContent = filesSummary;
          if (pdfMissing.length || pdfExtra.length) {
            const tip = [];
            if (pdfMissing.length) tip.push(`нет в FS: ${pdfMissing.slice(0,20).join(', ')}${pdfMissing.length>20?'...':''}`);
            if (pdfExtra.length) tip.push(`лишние в FS: ${pdfExtra.slice(0,20).join(', ')}${pdfExtra.length>20?'...':''}`);
            pdfEl.title = tip.join(' | ');
          } else {
            pdfEl.removeAttribute('title');
          }
          document.getElementById('st-ver').textContent = data.version || '-';
        } catch (e) {
          document.getElementById('st-db').innerHTML = '<span class="err">error</span>';
        }
      }} else {
            pdfEl.removeAttribute('title');
          }
          document.getElementById('st-ver').textContent = data.version || '-';
        } catch (e) {
          document.getElementById('st-db').innerHTML = '<span class="err">error</span>';
        }
      }
    })();
  </script>
</body>
</html>


